cmake_minimum_required(VERSION 3.14)
project(json_transport)

## Compile as C++17
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

add_compile_options("-Wall;-Werror")

find_package(catkin REQUIRED COMPONENTS
  json_msgs
  roscpp
)

include(cmake/nlohmann-json.cmake)

include_directories(
  include
  ${catkin_INCLUDE_DIRS}
)

catkin_package(
  INCLUDE_DIRS
    include
  CATKIN_DEPENDS
    json_msgs
    roscpp
)
catkin_python_setup()

install(DIRECTORY include/${PROJECT_NAME}/
  DESTINATION ${CATKIN_PACKAGE_INCLUDE_DESTINATION}
)

install(FILES requirements.txt
  DESTINATION ${CATKIN_PACKAGE_SHARE_DESTINATION}
)

# Currently there's an issue where `catkin_install_python` is overridden by catkin_virtualenv
# which causes issues when building with catkin_make. Disable this testing for now to avoid the issue.

# if(CATKIN_ENABLE_TESTING)
#   find_package(catkin_virtualenv)
#   find_package(roslint)

#   catkin_generate_virtualenv(
#     INPUT_REQUIREMENTS requirements.in
#   )

#   roslint_cpp()
#   roslint_python()

#   catkin_install_python(
#   PROGRAMS
#     test/talker_py
#     test/test_listener_py
#     test/test_packed_json.py
#   DESTINATION ${CATKIN_PACKAGE_BIN_DESTINATION})

#   add_executable(talker_cpp test/talker.cpp)
#   target_link_libraries(talker_cpp ${catkin_LIBRARIES})

#   catkin_add_executable_with_gtest(test_listener_cpp test/test_listener.cpp)
#   target_link_libraries(test_listener_cpp ${catkin_LIBRARIES})

#   find_package(rostest)
#   add_rostest(test/transport.test ARGS talker_node:=talker_py)
#   add_rostest(test/transport.test ARGS talker_node:=talker_cpp)
#   catkin_add_nosetests(test/test_packed_json.py)

# endif()
